<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrador de IDs</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <style>
body {
  font-family: 'Open Sans', sans-serif;
  margin: 0;
  background: #f9f9f9;
  color: #333;
}

header {
  background-color: #0072C6;
  color: white;
  padding: 24px 20px;
  text-align: center;
  font-size: 1.5rem;
  font-weight: 600;
}

.container {
  max-width: 960px;
  margin: 40px auto;
  padding: 0 20px;
}

form, .card {
  background: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  margin-bottom: 30px;
}

input, select, textarea {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-sizing: border-box;
  margin-bottom: 20px;
}

textarea {
  min-height: 200px;
  resize: vertical;
}

button {
  background-color: #0072C6;
  color: #fff;
  padding: 12px 24px;
  font-size: 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s ease;
}

button:hover {
  background-color: #005999;
}

.acciones {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.acciones button {
  flex: 1;
}

.volver {
  display: block;
  margin: 20px auto;
  width: fit-content;
  text-decoration: none;
  color: #0072C6;
  font-weight: 500;
}

.volver:hover {
  text-decoration: underline;
}

.card {
  border-left: 4px solid #0072C6;
  padding-left: 20px;
}

.card h3 {
  margin: 0 0 10px;
}

.card p {
  margin: 5px 0;
}

.card .id {
  font-weight: bold;
  color: #555;
}

.form-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.col-izquierda {
  flex: 1;
  min-width: 250px;
}

.col-derecha {
  flex: 2;
}

.col-derecha textarea {
  width: 100%;
  height: 300px;
  box-sizing: border-box;
  resize: vertical;
}

@media (max-width: 768px) {
  .form-grid {
    flex-direction: column;
  }
}

input, textarea {

  padding: 14px;
  font-size: 16px;
  border: 2px solid #000; /* Borde negro más grueso */
  border-radius: 8px;
  background-color: #fff; /* Fondo blanco */
  color: #333;
  box-sizing: border-box;
  margin-bottom: 20px;
}

 select {
  width: 100%;
  padding: 14px;
  font-size: 16px;
  border: 2px solid #000; /* Borde negro más grueso */
  border-radius: 8px;
  background-color: #fff; /* Fondo blanco */
  color: #333;
  box-sizing: border-box;
  margin-bottom: 20px;
  appearance: none; /* Quita estilo por defecto en algunos navegadores */
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml;utf8,<svg fill='black' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
}
select:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.3); /* Simula contorno negro alrededor del dropdown */
}
.descripcion {
  white-space: pre-wrap;
}

  </style>
</head>
<body>
  <header>
    <h1>Administrador</h1>
  </header>
  <!--<a class="volver" href="index.html">← Volver al buscador</a>-->

  <form id="formulario">
      <div class="form-grid">
        <div class="col-izquierda">
          <input type="text" id="id" placeholder="ID" required>
          <input type="text" id="titulo" placeholder="Título" required>
          <select id="categoria" required>
          
          </select>
        </div>
        <div class="col-derecha">
          <textarea id="descripcion" placeholder="Descripción" required></textarea>
        </div>
      </div>
      <button type="submit">Guardar</button>
    </form>
    
  <div class="container">
    <h3>Exportar una sola categoría</h3>
    <select id="exportarCategoria">
    
    </select>
    <button onclick="exportarCategoriaSeleccionada()">Exportar categoría seleccionada</button>


    <h3>Filtrar visualización por categoría</h3>
    <select id="filtroCategoria" onchange="mostrarDatos()">

    </select>

    
    <div id="lista"></div>
  </div>

  <script>
    let datos = [];

    let documentos = [];

    // Cargar index.json con la lista de documentos y poblar selects
    async function cargarConfig() {
      try {
        const res = await fetch("datos/index.json");
        documentos = await res.json();

        const selectCat = document.getElementById("categoria");
        const filtroCat = document.getElementById("filtroCategoria");
        const exportarCat = document.getElementById("exportarCategoria");

        // Reiniciar opciones
        selectCat.innerHTML = `<option value="">Selecciona una categoría</option>`;
        filtroCat.innerHTML = `<option value="">Todas las categorías</option>`;
        exportarCat.innerHTML = `<option value="">Selecciona una categoría</option>`;

        documentos.forEach((doc, i) => {
          // Mostrar nombre con número, y usar ese mismo texto como value (igual al campo categoria de los JSON)
          const nombreConNumero = `${i + 1}.${doc.nombre}`;
          selectCat.add(new Option(nombreConNumero, nombreConNumero));
          filtroCat.add(new Option(nombreConNumero, nombreConNumero));
          exportarCat.add(new Option(nombreConNumero, nombreConNumero));
        });


        // Cargar todos los JSON listados en index.json
        cargarTodosLosJSON();
      } catch (e) {
        console.error("Error cargando index.json", e);
      }
    }


    const form = document.getElementById('formulario');
    const lista = document.getElementById('lista');

    async function cargarTodosLosJSON() {
      let todosLosDatos = [];
      for (const doc of documentos) {
        try {
          const res = await fetch(`datos/${doc.archivo}`);
          const contenido = await res.json();
          todosLosDatos = todosLosDatos.concat(contenido);
        } catch (e) {
          console.warn(`No se pudo cargar ${doc.archivo}`, e);
        }
      }
      datos = todosLosDatos;
      mostrarDatos();
    }


    function mostrarDatos() {
      const filtro = document.getElementById("filtroCategoria")?.value || "";
      lista.innerHTML = '';

      datos
        .filter(item => !filtro || item.categoria === filtro)
        .sort((a, b) => parseInt(a.id) - parseInt(b.id))
        .forEach((item, index) => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div class="id">ID: ${item.id}</div>
            <h3>${item.titulo}</h3>
            <p class="descripcion">${item.descripcion}</p>
            <p><strong>Categoría:</strong> ${item.categoria || "Sin categoría"}</p>
            <div class="acciones">
              <button onclick="editarPorId('${item.id}', '${item.categoria}')">Editar</button>
              <button onclick="eliminarPorId('${item.id}', '${item.categoria}')">Eliminar</button>
            </div>
          `;
          lista.appendChild(div);
        });
    }
    function editarPorId(id, categoria) {
      const index = datos.findIndex(item => item.id === id && item.categoria === categoria);
      if (index === -1) return;

      const item = datos[index];
      document.getElementById('id').value = item.id;
      document.getElementById('titulo').value = item.titulo;
      document.getElementById('descripcion').value = item.descripcion;
      document.getElementById('categoria').value = item.categoria;

      datos.splice(index, 1);
      mostrarDatos();
      form.scrollIntoView({ behavior: "smooth", block: "start" });
    }


    function eliminarPorId(id, categoria) {
      if (!confirm("¿Eliminar este registro?")) return;

      const index = datos.findIndex(item => item.id === id && item.categoria === categoria);
      if (index !== -1) {
        datos.splice(index, 1);
        mostrarDatos();
      }
    }

    document.getElementById("categoria").addEventListener("change", () => {
      const categoriaTexto = document.getElementById("categoria").value;

      // Filtrar artículos con esa categoría
      const articulosCategoria = datos.filter(item => item.categoria === categoriaTexto);

      // Obtener el máximo ID como número
      let maxId = 0;
      articulosCategoria.forEach(item => {
        const num = parseInt(item.id);
        if (!isNaN(num) && num >= maxId) {
          maxId = num;
        }
      });

      // Sugerir el siguiente
      document.getElementById("id").placeholder = `Sugerido: ${maxId + 1}`;
    });
    

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('id').value.trim();
      const titulo = document.getElementById('titulo').value.trim();
      const descripcion = document.getElementById('descripcion').value.trim();
      const categoriaTexto = document.getElementById('categoria').value;

      // Verificar si ya existe el mismo ID en la misma categoría
      const idsEnCategoria = datos
        .filter(item => item.categoria === categoriaTexto)
        .map(item => parseInt(item.id))
        .filter(num => !isNaN(num));

      if (idsEnCategoria.includes(parseInt(id))) {
        const maxId = Math.max(...idsEnCategoria);
        alert(`Ya existe el ID "${id}" en la categoría "${categoriaTexto}".\n\nNúmero recomendado: ${maxId + 1}`);
        return;
      }

      datos.push({ id, titulo, descripcion, categoria: categoriaTexto });

      // Ordenar por ID
      datos.sort((a, b) => parseInt(a.id) - parseInt(b.id));
      form.reset();
      mostrarDatos();
    });


    function descargarJSON() {
      const categorias = {};

      // Agrupar datos por categoría
      datos.forEach(item => {
        const nombreCategoria = item.categoria || "Sin categoría";
        if (!categorias[nombreCategoria]) {
          categorias[nombreCategoria] = [];
        }
        categorias[nombreCategoria].push(item);
      });

      const nombresOrdenados = Object.keys(categorias)
        .sort((a, b) => a.localeCompare(b));

      nombresOrdenados.forEach((nombreCategoria, index) => {
        const datosCategoria = categorias[nombreCategoria];

        const datosNumerados = datosCategoria.map((item, idx) => ({
          ...item,
          titulo: item.titulo.replace(/^\d+\.\s*/, '')
        }));

        const blob = new Blob([JSON.stringify(datosNumerados, null, 2)], { type: "application/json" });

        const nombreLimpio = nombreCategoria
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // quitar tildes
          .replace(/\s+/g, "_") // reemplazar espacios
          .replace(/[^a-zA-Z0-9_.]/g, "") // permitir punto
          .toLowerCase();

        const nombreArchivo = `${index + 1}.${nombreLimpio}.json`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = nombreArchivo;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    async function cargarTodosLosJSON() {
      let todosLosDatos = [];
      for (const doc of documentos) {
        try {
          const res = await fetch(`datos/${doc.archivo}`);
          const contenido = await res.json();
          todosLosDatos = todosLosDatos.concat(contenido);
        } catch (e) {
          console.warn(`No se pudo cargar ${doc.archivo}`, e);
        }
      }
      datos = todosLosDatos;
      mostrarDatos();
    }

    function exportarCategoriaSeleccionada() {
      const categoria = document.getElementById("exportarCategoria").value;
      if (!categoria) {
        alert("Selecciona una categoría primero");
        return;
      }

      const datosCategoria = datos.filter(item => item.categoria === categoria);
      if (datosCategoria.length === 0) {
        alert("No hay datos en esta categoría");
        return;
      }

      const blob = new Blob([JSON.stringify(datosCategoria, null, 2)], { type: "application/json" });
      const nombreArchivo = categoria
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "_")
        .replace(/[^a-zA-Z0-9_.]/g, "")
        .toLowerCase() + ".json";

      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = nombreArchivo;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
cargarConfig();


  </script>
</body>
</html>
